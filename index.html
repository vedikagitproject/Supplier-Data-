<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PO Data Form</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    form { margin-bottom: 20px; }
    input, button { margin: 5px; padding: 5px; }
    table, th, td { border: 1px solid #999; border-collapse: collapse; padding: 8px; }
    th { background-color: #f0f0f0; }
    .pending { background-color: #ffcccb; }
    .fulfilled { background-color: #d4f3d4; }
  </style>
</head>
<body>
  <h2>Supplier PO Entry</h2>
  <form id="poForm">
    <input type="date" name="poDate" placeholder="PO Date" required />
    <input type="text" name="supname" placeholder="Supplier Name" required />
    <input type="text" name="itemNo" placeholder="Item No." required />
    <input type="text" name="itemName" placeholder="Item Name" required />
    <input type="number" name="poQty" placeholder="PO Qty" required />
    <input type="number" name="pendingQty" placeholder="Pending PO Qty" required />
    <input type="text" name="refPONo" placeholder="Ref. PO No." required />
    <button type="submit">Submit</button>
  </form>

  <h3>Previous PO Data</h3>
  <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()">
  <br><br>
  <input type="date" id="startDate">
  <input type="date" id="endDate">
  <button onclick="filterByDate()">Filter by Date</button>
  <button onclick="exportToExcel()">Export to Excel</button>
  <button onclick="exportToPDF()">Export to PDF</button>
  
  <table id="poTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">PO Date</th>
        <th onclick="sortTable(1)">Supplier</th>
        <th onclick="sortTable(2)">Item No.</th>
        <th onclick="sortTable(3)">Item Name</th>
        <th onclick="sortTable(4)">PO Qty</th>
        <th onclick="sortTable(5)">Pending Qty</th>
        <th onclick="sortTable(6)">Ref. PO No.</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzGCf5gLwpfPcRzvDotLarmWgQpr9DxlpadDi7q5hN-i9mONWmH6k4oSZwFNwAFTIOi/exec'; 

    document.getElementById('poForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;

      const data = {
        poDate: form.poDate.value,
        supname: form.supname.value,
        itemNo: form.itemNo.value,
        itemName: form.itemName.value,
        poQty: form.poQty.value,
        pendingQty: form.pendingQty.value,
        refPONo: form.refPONo.value
      };

      const response = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('Data submitted!');
        form.reset();
        loadTable();
      } else {
        alert('Error submitting data.');
      }
    });

    async function loadTable() {
      const res = await fetch(scriptURL);
      const data = await res.json();

      const tbody = document.querySelector('#poTable tbody');
      tbody.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.poDate}</td>
          <td>${row.supname}</td>
          <td>${row.itemNo}</td>
          <td>${row.itemName}</td>
          <td>${row.poQty}</td>
          <td>${row.pendingQty}</td>
          <td>${row.refPONo}</td>
          <td>
            <button onclick="editRow(this)">Edit</button>
            <button onclick="deleteRow(this)">Delete</button>
          </td>
        `;
        addRowActions(tr, row); // Add actions like edit/delete to each row
        tbody.appendChild(tr);
      });
      
      highlightOrders(); // Highlight pending vs fulfilled orders
    }

    function highlightOrders() {
      const rows = document.querySelectorAll('#poTable tbody tr');
      rows.forEach(row => {
        const pendingQty = parseInt(row.cells[5].textContent);
        if (pendingQty > 0) {
          row.classList.add('pending');
        } else {
          row.classList.add('fulfilled');
        }
      });
    }

    function addRowActions(row, data) {
      const editButton = row.querySelector('button:nth-child(1)');
      const deleteButton = row.querySelector('button:nth-child(2)');

      editButton.onclick = () => editRow(data);
      deleteButton.onclick = () => deleteRow(row);
    }

    function editRow(data) {
      const form = document.getElementById('poForm');
      form.poDate.value = data.poDate;
      form.supname.value = data.supname;
      form.itemNo.value = data.itemNo;
      form.itemName.value = data.itemName;
      form.poQty.value = data.poQty;
      form.pendingQty.value = data.pendingQty;
      form.refPONo.value = data.refPONo;
    }

    function deleteRow(row) {
      row.remove();
    }

    function sortTable(n) {
      const table = document.getElementById("poTable");
      const rows = Array.from(table.rows).slice(1); 

      const sortedRows = rows.sort((rowA, rowB) => {
        const cellA = rowA.cells[n].textContent.trim();
        const cellB = rowB.cells[n].textContent.trim();
        
        return cellA > cellB ? 1 : cellA < cellB ? -1 : 0;
      });

      sortedRows.forEach(row => table.appendChild(row));
    }

    function searchTable() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#poTable tbody tr');

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let match = false;
        cells.forEach(cell => {
          if (cell.textContent.toLowerCase().includes(searchValue)) {
            match = true;
          }
        });
        row.style.display = match ? '' : 'none';
      });
    }

    function filterByDate() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);

      const rows = document.querySelectorAll('#poTable tbody tr');
      rows.forEach(row => {
        const poDate = new Date(row.cells[0].textContent);
        if (poDate >= startDate && poDate <= endDate) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    function exportToExcel() {
      const table = document.getElementById('poTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: "PO Data" });
      XLSX.writeFile(wb, 'PO_Data.xlsx');
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const table = document.getElementById('poTable');
      let rows = [];
      table.querySelectorAll('tr').forEach((tr) => {
        rows.push(Array.from(tr.querySelectorAll('td, th')).map(td => td.textContent));
      });
      
      doc.autoTable({
        head: [rows[0]], 
        body: rows.slice(1)
      });

      doc.save('PO_Data.pdf');
    }

    loadTable(); // Load table when page loads
  </script>
</body>
</html>
